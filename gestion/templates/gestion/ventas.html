<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kiosco - Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .lista-productos { max-height: 500px; overflow-y: auto; }
        .ticket { background-color: #f8f9fa; border-left: 2px solid #ddd; height: 100vh; }
        .total-box { font-size: 2rem; font-weight: bold; color: green; }
        .producto-encontrado { background-color: #d1e7dd !important; transition: background 0.5s; }
    </style>
</head>
<body>

    {% if not caja_abierta %}
    <div class="alert alert-warning text-center m-0 rounded-0" role="alert">
        <strong>‚ö†Ô∏è LA CAJA EST√Å CERRADA.</strong> No podr√°s registrar ventas hasta que inicies turno.
        <a href="{% url 'apertura_caja' %}" class="btn btn-primary btn-sm ms-3">üîì ABRIR CAJA AHORA</a>
    </div>
    {% endif %}

   <div class="container-fluid mt-3 mb-2">
    <div class="d-flex justify-content-end gap-2">
        
        <a href="{% url 'exportar_excel' %}" class="btn btn-success">
            üìä Exportar Ventas
        </a>

        {% if user.is_staff %}
            <a href="{% url 'exportar_productos_excel' %}" class="btn btn-info text-white">
                üìã Inventario
            </a>
            <a href="{% url 'reporte_mensual' %}" class="btn btn-dark">
                üìà Ganancias
            </a>
        {% endif %}
        
        {% if caja_abierta %}
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalMovimiento">
                üí∏ Ingreso/Egreso
            </button>
            
            <a href="{% url 'cierre_caja' %}" class="btn btn-warning">
                üîí Cerrar Caja
            </a>
        {% endif %}

        {% if user.is_staff %}
            <a href="{% url 'admin:index' %}" class="btn btn-warning fw-bold me-2">
               ‚öôÔ∏è Panel Admin
            </a>
        {% endif %}

        <form action="{% url 'logout' %}" method="post" class="d-inline">
             {% csrf_token %}
            <button type="submit" class="btn btn-dark ms-2">üö™ Salir</button>
        </form>
    </div>
</div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 p-4">
                <h2>üì¶ Productos</h2>

                <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                   <button class="btn btn-outline-dark fw-bold active" onclick="filtrarCategoria('TODOS', this)">
                      ‚ôæÔ∏è TODOS
                 </button>
    
                  {% for c in categorias %}
                  <button class="btn btn-outline-secondary fw-bold text-uppercase text-nowrap" 
                         onclick="filtrarCategoria('{{ c.id }}', this)">
                      {{ c.nombre }}
                  </button>
                  {% endfor %}
              </div>
                
                <div class="input-group mb-3">
                    <span class="input-group-text">üîç (F9)</span>
                    <input type="text" id="buscador" class="form-control form-control-lg" placeholder="Escanear c√≥digo o buscar nombre..." autofocus autocomplete="off">
                </div>

                <div class="lista-productos">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>C√≥digo</th>
                                <th>Producto</th>
                                <th>Stock</th> 
                                <th>Precio</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos">
                          {% for p in productos %}
                          <tr class="producto-row {% if p.stock_actual == 0 %}table-danger{% elif p.stock_actual <= 5 %}table-warning{% endif %}" 
                              data-categoria="{{ p.categoria.id|default:'SIN_CAT' }}">
                             <td class="codigo-producto">{{ p.codigo }}</td>
                             <td class="nombre-producto">
                                 {{ p.nombre }}
                                 {% if p.stock_actual == 0 %}
                                     <span class="badge bg-danger">SIN STOCK</span>
                                 {% endif %}
                             </td>
        
                             <td class="fw-bold">
                                 {% if p.tipo_venta == 'UNIDAD' %}
                                     {{ p.stock_actual|floatformat:0 }} <small class="text-muted fw-normal">U</small>
                                 {% else %}
                                     {{ p.stock_actual|floatformat:3 }} <small class="text-muted fw-normal">kg</small>
                                 {% endif %}
                             </td>
        
                             <td>${{ p.precio_venta }}</td>
        
                             <td>
                                 <button class="btn btn-primary btn-sm btn-agregar" 
                                        onclick="agregarAlCarrito('{{ p.id }}', '{{ p.nombre }}', '{{ p.precio_venta }}', '{{ p.tipo_venta }}')"
                                        {% if not caja_abierta or p.stock_actual == 0 %}disabled{% endif %}> 
                                      + Agregar
                                  </button>
                             </td>
                            </tr>
                            {% endfor %}
                      </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-4 ticket p-4">
                <h3 class="text-center">üõí Nueva Venta</h3>
                <hr>
                
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Cant</th>
                            <th>Prod</th>
                            <th class="text-end">Subtotal</th>
                            <th style="width: 30px;"></th>
                        </tr>
                    </thead>
                    <tbody id="carrito-body">
                        </tbody>
                </table>

                <hr>
                <div class="text-end">
                    <h4>Total: <span class="total-box" id="total-venta">$0.00</span></h4>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-success btn-lg" 
                            id="btn-cobrar"
                            onclick="cobrar()" 
                            {% if not caja_abierta %}disabled{% endif %}>
                        üí∞ Cobrar (F10)
                    </button>
                    <button class="btn btn-danger" onclick="limpiarCarrito()">üóë Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="modalMovimiento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title">Registrar Movimiento de Caja</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'registrar_movimiento' %}" method="POST">
        {% csrf_token %}
        <div class="modal-body">
            
            <div class="mb-3">
                <label class="form-label fw-bold">Tipo de Movimiento</label>
                <select name="tipo" class="form-select" id="select-tipo" onchange="actualizarCategorias()" required>
                    <option value="EGRESO">üì§ EGRESO (Salida de dinero)</option>
                    <option value="INGRESO">üì• INGRESO (Entrada de dinero)</option>
                </select>
            </div> <div class="mb-3">
                <label class="form-label fw-bold">Categor√≠a / Motivo</label>
                <select name="categoria" class="form-select" id="select-categoria" required>
                    </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Monto ($)</label>
                <input type="number" step="0.01" name="monto" class="form-control" placeholder="0.00" required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Descripci√≥n</label>
                <input type="text" name="descripcion" class="form-control" placeholder="Ej: Pago a preventista Arcor" required>
            </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <div class="modal fade" id="modalCobro" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">üí∞ Finalizar Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h2 class="text-center fw-bold mb-4">Total: <span id="modal-total-pagar">$0.00</span></h2>
                    
                    <div class="mb-3">
                        <label class="form-label">M√©todo de Pago</label>
                        <select id="metodo-pago" class="form-select form-select-lg">
                            <option value="EFECTIVO">üíµ Efectivo</option>
                            <option value="MERCADOPAGO">üì± Mercado Pago</option>
                            <option value="VALE">üìù VALE / EMPLEADO (Fiado)</option>
                            <option value="DEBITO">üí≥ D√©bito</option>
                            <option value="CREDITO">üí≥ Cr√©dito</option>
                        </select>
                    </div>

                    <div id="seccion-efectivo">
                        <div class="mb-3">
                            <label class="form-label">Paga con ($)</label>
                            <input type="number" id="paga-con" class="form-control form-control-lg text-end" oninput="calcularVuelto()" placeholder="0.00">
                        </div>
                        <div class="alert alert-info text-center">
                            <strong>Vuelto: </strong> <span id="vuelto-texto" class="fs-4">$0.00</span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                    <button type="button" class="btn btn-success btn-lg" onclick="confirmarVenta()">‚úÖ CONFIRMAR VENTA</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalExito" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-body p-5">
                    <div style="font-size: 60px;">‚úÖ</div>
                    <h2 class="fw-bold mt-3 text-success">¬°Venta Exitosa!</h2>
                    <p class="text-muted">La operaci√≥n se registr√≥ correctamente.</p>
                    
                    <hr class="my-4">
    
                    <h5 class="mb-3">¬øDesea imprimir el comprobante?</h5>
                    
                    <div class="d-flex justify-content-center gap-3 mb-4">
                        <input type="radio" class="btn-check" name="opcionTicket" id="optionNo" autocomplete="off">
                        <label class="btn btn-outline-secondary px-4 py-2" for="optionNo">No imprimir</label>
    
                        <input type="radio" class="btn-check" name="opcionTicket" id="optionSi" autocomplete="off" checked>
                        <label class="btn btn-outline-primary px-4 py-2" for="optionSi">üñ®Ô∏è S√≠, imprimir</label>
                    </div>
    
                    <button onclick="finalizarProceso()" class="btn btn-success w-100 btn-lg">
                        ACEPTAR Y CONTINUAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let carrito = [];
        let ultimaVentaId = null;
        const inputBuscador = document.getElementById('buscador');

        // --- 1. MODO LECTOR DE CODIGO
        
        inputBuscador.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                
                let codigo = this.value.trim();
                if (codigo === "") return;

                
                let filas = document.querySelectorAll('.producto-row');
                let encontrado = false;

                for (let fila of filas) {
                    let celdaCodigo = fila.querySelector('.codigo-producto').innerText.trim();
                    
                    if (celdaCodigo === codigo) {
                        
                        let boton = fila.querySelector('.btn-agregar');
                        if (!boton.disabled) {
                            boton.click(); 
                            
                            fila.classList.add('producto-encontrado');
                            setTimeout(() => fila.classList.remove('producto-encontrado'), 500);
                            
                            this.value = ''; 
                            mostrarTodasLasFilas(); 
                            encontrado = true;
                        } else {
                            alert("Producto sin stock o inactivo");
                            this.value = '';
                        }
                        break; 
                    }
                }

                if (!encontrado) {
                    
                    console.log("No se encontr√≥ c√≥digo exacto, manteniendo filtro...");
                }
            }
        });

        
        inputBuscador.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') return; 

            let texto = this.value.toLowerCase();
            let filas = document.querySelectorAll('.producto-row');

            filas.forEach(fila => {
                let contenido = fila.innerText.toLowerCase();
                fila.style.display = contenido.includes(texto) ? '' : 'none';
            });
        });

        function mostrarTodasLasFilas() {
            let filas = document.querySelectorAll('.producto-row');
            filas.forEach(f => f.style.display = '');
        }

        
        document.addEventListener('click', function(e) {
            
            const tagsIgnorados = ['INPUT', 'BUTTON', 'SELECT', 'TEXTAREA', 'A'];
            const esModal = e.target.closest('.modal');
            
            if (!tagsIgnorados.includes(e.target.tagName) && !esModal) {
                inputBuscador.focus();
            }
        });

        // Atajos Globales (F10, F9, ESC)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F10') {
                e.preventDefault();
                
                if (carrito.length > 0 && !document.querySelector('.modal.show')) {
                    cobrar();
                }
            }
            if (e.key === 'F9') {
                e.preventDefault();
                inputBuscador.focus();
                inputBuscador.select();
            }
        });


        //  FUNCIONES DEL CARRITO

        function agregarAlCarrito(id, nombre, precio, tipoVenta) {
            precio = parseFloat(precio.toString().replace(',', '.'));
            let item = carrito.find(i => i.id === id);
            
            if (item) {
                if (tipoVenta === 'UNIDAD') {
                    item.cantidad++;
                }
            } else {
                carrito.push({ id, nombre, precio, cantidad: 1, tipo: tipoVenta });
            }
            actualizarVista();
            inputBuscador.focus(); 
        }

        function cambiarCantidad(index, nuevaCantidad) {
            let valor = parseFloat(nuevaCantidad);
            if (valor > 0) {
                carrito[index].cantidad = valor;
            } 
            actualizarVista();
        }

        function actualizarVista() {
            let tbody = document.getElementById('carrito-body');
            tbody.innerHTML = '';
            let total = 0;

            carrito.forEach((item, index) => {
                let subtotal = item.cantidad * item.precio;
                total += subtotal;
                
                let step = item.tipo === 'PESO' ? '0.001' : '1';
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <input type="number" class="form-control form-control-sm px-1 text-center" 
                                   value="${item.cantidad}" min="0.001" step="${step}"
                                   onchange="cambiarCantidad(${index}, this.value)">
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 130px;">${item.nombre}</div>
                            <small class="text-muted">$${item.precio}</small>
                        </td>
                        <td class="text-end fw-bold">$${subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm py-0 px-1" onclick="eliminar(${index})">√ó</button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('total-venta').innerText = '$' + total.toFixed(2);
        }

        function eliminar(index) {
            carrito.splice(index, 1);
            actualizarVista();
            inputBuscador.focus();
        }

        function limpiarCarrito() {
            if(confirm("¬øVaciar carrito?")) {
                carrito = [];
                actualizarVista();
                inputBuscador.focus();
            }
        }

        // --- L√ìGICA DE COBRO ---

        function cobrar() {
            if (carrito.length === 0) {
                alert("El carrito est√° vac√≠o");
                return;
            }
            
            let total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
            
            document.getElementById('modal-total-pagar').innerText = '$' + total.toFixed(2);
            document.getElementById('paga-con').value = ''; 
            document.getElementById('vuelto-texto').innerText = '$0.00';
            
            var myModal = new bootstrap.Modal(document.getElementById('modalCobro'));
            myModal.show();
            
            
            document.getElementById('modalCobro').addEventListener('shown.bs.modal', function () {
                document.getElementById('paga-con').focus();
            });
        }

        function calcularVuelto() {
            let total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
            let pagaCon = parseFloat(document.getElementById('paga-con').value) || 0;
            let vuelto = pagaCon - total;
            
            let spanVuelto = document.getElementById('vuelto-texto');
            if (vuelto >= 0) {
                spanVuelto.innerText = '$' + vuelto.toFixed(2);
                spanVuelto.classList.remove('text-danger');
                spanVuelto.classList.add('text-success');
            } else {
                spanVuelto.innerText = "Falta: $" + Math.abs(vuelto).toFixed(2);
                spanVuelto.classList.add('text-danger');
            }
        }

        async function confirmarVenta() {
            let metodo = document.getElementById('metodo-pago').value;
            
            try {
                const response = await fetch('/cobrar/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ items: carrito, metodo_pago: metodo })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const modalCobro = bootstrap.Modal.getInstance(document.getElementById('modalCobro'));
                    modalCobro.hide();
                    
                    ultimaVentaId = data.venta_id;
                    const modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                    modalExito.show();
                    
                    carrito = [];
                    actualizarVista();
                } else {
                    alert("‚ùå Error: " + data.mensaje);
                }

            } catch (error) {
                console.error('Error:', error);
                alert("Error de conexi√≥n");
            }
        }

        function finalizarProceso() {
            let quiereImprimir = document.getElementById('optionSi').checked;
            
            if (quiereImprimir && ultimaVentaId) {
                let w = 350, h = 600;
                let left = (screen.width / 2) - (w / 2);
                let top = (screen.height / 2) - (h / 2);
                window.open('/ticket/' + ultimaVentaId + '/', 'Ticket', `width=${w},height=${h},top=${top},left=${left},scrollbars=yes`);
            }
            location.reload();
        }

        // --- FILTRO POR CATEGOR√çAS ---
    function filtrarCategoria(idCategoria, boton) {
        
        document.querySelectorAll('.btn-outline-dark').forEach(b => {
            b.classList.remove('btn-outline-dark', 'active');
            b.classList.add('btn-outline-secondary');
        });
        boton.classList.remove('btn-outline-secondary');
        boton.classList.add('btn-outline-dark', 'active');

        
        let filas = document.querySelectorAll('.producto-row');
        
        filas.forEach(fila => {
            
            let catFila = fila.getAttribute('data-categoria');
            
            
            if (idCategoria === 'TODOS' || catFila === idCategoria) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });

        
        const inputBuscador = document.getElementById('buscador');
        if(inputBuscador) {
            inputBuscador.value = '';
            inputBuscador.focus();
        }
    }

    </script> <script>
        function actualizarCategorias() {
            const tipo = document.getElementById('select-tipo').value;
            const catSelect = document.getElementById('select-categoria');
            catSelect.innerHTML = ''; 
    
            if (tipo === 'EGRESO') {
                catSelect.innerHTML += `
                    <option value="PROVEEDOR">üì¶ Pago a Proveedores (Mercader√≠a)</option>
                    <option value="GASTO_FIJO">üí° Gasto Fijo (Luz, Alquiler)</option>
                    <option value="GASTO_VARIO">üßπ Gasto Vario (Insumos, Limpieza)</option>
                    <option value="RETIRO_SOCIO">üíµ Retiro de Ganancia (Due√±o)</option>
                `;
            } else {
                catSelect.innerHTML += `
                    <option value="OTROS_INGRESOS">üí∞ Cambio / Aporte de Caja</option>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', actualizarCategorias);
    </script>

</body>
</html>